name: Protect Main and Auto-version

on:
  pull_request_target:
    types:
      - opened
      - reopened
    branches:
      - main
jobs:
  close:
    runs-on: ubuntu-latest
    outputs:
      closed: ${{ steps.close.outputs.closed }}
      issue: ${{ steps.issue.outputs.issue }}
    steps:
      - name: Check if valid feature or bugfix branch
        run: >
          echo "VALID_BRANCH_NAME=$([[ 'FEATURE-AQC-1111-first-pr' =~ (FEATURE|BUGFIX)-AQC-[0-9]+-.+ ]] && echo true)" >> $GITHUB_ENV

      - name: Increment version number based on branch name
        run: |
          python -c "
          import os
          import re
          issue_type = env.ISSUE_TYPE
          version_file = 'code/django/version.txt'
          with open(version_file, 'r') as file:
              version = file.read().strip()
          match = re.match(r'(\d+)\.(\d+)\.(\d+)(-.+)?', version)
          if match:
              major, minor, patch, prerelease = match.groups()
              if issue_type == 'FEATURE':
                  minor = int(minor) + 1   
              elif issue_type == 'BUGFIX':
                  patch = int(patch) + 1  
              new_version = f'{major}.{minor}.{patch}{prerelease or ""}'
              with open(version_file, 'w') as file:
                  file.write(new_version)
          else:
              raise ValueError('Version format not recognized')
